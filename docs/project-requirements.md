# 🌙 MoonVPN - Project Requirements (Final)

## 🧩 Project Goal
Create a full-featured Telegram-based VPN service management system using Python, Docker, and 3x-ui integration, with full role-based user access, wallet system, order tracking, notifications, and CLI automation.

---

## ✅ Key Functional Requirements

### 1. User Roles
- `user`: خرید پلن و مشاهده اطلاعات اکانت و تمدید
- `admin`: افزودن پنل، تعریف پلن، بررسی سفارشات، تنظیمات سیستمی
- `reseller`: فروشنده‌ها با دسترسی محدود، امکان فروش با پلن‌های تخفیفی در آینده

### 2. User Features
- ثبت‌نام خودکار با start
- دریافت پلن تست در صورت فعال بودن
- لیست پلن‌ها بر اساس لوکیشن
- خرید پلن و دریافت لینک کانفیگ نهایی
- تمدید اکانت، ریست ترافیک و حذف دستی توسط کاربر
- مشاهده اعتبار، ترافیک باقیمانده، و تاریخ انقضا

### 3. Admin Features
- افزودن و مدیریت پنل 3x-ui (تنها توسط admin)
- مانیتورینگ وضعیت پنل و inbounds
- ایجاد، ویرایش و غیرفعال کردن پلن‌ها
- مدیریت سفارشات و تراکنش‌ها
- مدیریت کدهای تخفیف، درصدی/ثابت، محدودیت، انقضا
- نوتیفیکیشن گروهی (اطلاع‌رسانی عمومی)

### 4. Notifications
- پیام به کاربران درباره اتمام حجم/تاریخ
- ارسال اعلان‌های خرید موفق یا رد سفارش
- آمار کلی پیام‌ها: موفق / ناموفق / در صف
- ارسال به کانال عمومی یا ادمین در صورت نیاز

### 5. VPN Panel Integration
- اتصال مستقیم با 3x-ui پنل از طریق py3xui
- دریافت لیست inbounds
- ساخت، حذف، تمدید، و ریست اکانت کاربران
- UUID و config_url گرفته‌شده از پنل ذخیره می‌شود

### 6. Account Naming
- بر اساس الگوی: `FR-Moonvpn-012[-01]`
- شمارنده با هر انتقال لوکیشن افزایش می‌یابد
- کاربران می‌توانند نام سفارشی بدهند یا از پیش‌فرض استفاده کنند

### 7. Location Switching Logic
- بررسی باقی‌مانده حجم/زمان
- ساخت اکانت جدید در پنل مقصد
- ارسال لینک جدید
- حذف اکانت قبلی
- ذخیره‌سازی در جدول `account_transfer`

### 8. Payment & Wallet System
- کیف پول داخلی با تراکنش‌های قابل پیگیری
- درگاه مستقیم (مثلاً زرین‌پال) + دستی کارت به کارت
- تخفیف‌ قابل تنظیم و مدیریت کامل

### 9. Test Account Control
- فقط ۱ بار برای هر پلن/کاربر
- ثبت در جدول `test_account_log`

### 10. Deployment Requirements
- اجرای کامل با Docker
- استفاده از `moonvpn` CLI برای مدیریت:
  - اجرای سرویس‌ها، مشاهده لاگ، انجام migrations
- دسترسی گرافیکی به دیتابیس از طریق phpMyAdmin

---

## ⚙️ Technologies
- Python 3.12+
- Aiogram 3.x
- SQLAlchemy 2.x
- Alembic
- Redis
- MySQL 8.3+
- Docker & Compose
- Poetry
- py3xui (3x-ui SDK)

---

## 🔐 Security & Performance
- دسترسی بر اساس نقش‌ها
- فیلتر پلن‌ها بر اساس لوکیشن
- ذخیره فقط اطلاعات ضروری اکانت‌ها و ترافیک مصرف‌شده
- استفاده از Redis برای session و caching
- لاگ‌گیری دقیق، ارور هندلینگ، نوتیف به ادمین در رخدادها

---

## 🛠 Roadmap Summary (Phases)
1. راه‌اندازی ساختار و پایگاه داده
2. اتصال به پنل و تست ساخت اکانت
3. پیاده‌سازی ربات با خرید پلن کامل
4. مدیریت سفارش و کیف پول
5. نوتیفیکیشن، تست اکانت و تخفیف
6. پنل ادمین و امکانات مکمل

