# 🧾 راهنمای تأیید تراکنش‌ها (Confirm Payment)

این مستند روش استفاده از ابزار تأیید تراکنش پرداخت در MoonVPN را توضیح می‌دهد.

## 📝 نگاه کلی

ابزار تأیید تراکنش (`confirm_payment`) به شما امکان می‌دهد تراکنش‌های پرداخت را به صورت دستی و از طریق خط فرمان تأیید کنید. این عملیات:
- وضعیت تراکنش را به `success` تغییر می‌دهد
- موجودی کیف پول کاربر را افزایش می‌دهد
- نوتیفیکیشن مناسب را برای کاربر و ادمین ارسال می‌کند

## 🛠️ دستور خط فرمان

### تأیید با شناسه تراکنش

برای تأیید یک تراکنش با شناسه تراکنش، از دستور زیر استفاده کنید:

```bash
moonvpn shell app
python -m core.scripts.confirm_payment --txn TRANSACTION_ID
```

### تأیید با شناسه سفارش

برای تأیید تراکنش مرتبط با یک سفارش، از دستور زیر استفاده کنید:

```bash
moonvpn shell app
python -m core.scripts.confirm_payment --order ORDER_ID
```

## 📋 نمونه استفاده

برای تأیید تراکنش با شناسه `123`:

```bash
moonvpn shell app
python -m core.scripts.confirm_payment --txn 123
```

خروجی پس از اجرای موفق:

```
✅ تراکنش 123 با موفقیت تأیید شد.
👤 کاربر 98765432
💰 مبلغ: 100000.00 تومان
```

## 📱 سیستم نوتیفیکیشن

پس از تأیید تراکنش، سیستم به صورت خودکار دو نوتیفیکیشن ارسال می‌کند:

1. **به کاربر**: اطلاع‌رسانی در مورد تأیید تراکنش و موجودی جدید
2. **به ادمین‌ها**: اطلاع‌رسانی در مورد تأیید تراکنش

### تست نوتیفیکیشن

برای تست سیستم نوتیفیکیشن، می‌توانید از یکی از روش‌های زیر استفاده کنید:

#### 1. از طریق بات تلگرام (در صورت فعال بودن بات)

دستور `/test_notify` را در بات ارسال کنید تا یک پیام تست دریافت کنید.

#### 2. از طریق خط فرمان

می‌توانید نوتیفیکیشن‌ها را با اسکریپت `test_notification.py` در محیط CLI تست کنید:

```bash
# ارسال نوتیفیکیشن به کاربر مشخص
moonvpn shell app
python -m core.scripts.test_notification --user_id TELEGRAM_ID --message "پیام تست"

# ارسال نوتیفیکیشن به همه ادمین‌ها
python -m core.scripts.test_notification --user_id 123456789 --admin --message "پیام تست ادمین"

# ارسال نوتیفیکیشن به کانال
python -m core.scripts.test_notification --user_id 123456789 --channel --message "پیام تست کانال"
```

## ✅ تست و بررسی

برای اطمینان از عملکرد صحیح این ویژگی، موارد زیر را بررسی کنید:

1. **بررسی دیتابیس**: پس از تأیید پرداخت، از طریق phpMyAdmin یا دسترسی مستقیم به دیتابیس، وضعیت تراکنش و همچنین افزایش موجودی کاربر را بررسی کنید:

```sql
-- بررسی وضعیت تراکنش
SELECT * FROM transactions WHERE id = TRANSACTION_ID;

-- بررسی موجودی کاربر
SELECT id, telegram_id, balance FROM users WHERE id = USER_ID;
```

2. **بررسی نوتیفیکیشن**: پس از تأیید پرداخت، کاربر باید پیام مناسبی دریافت کند که حاوی مبلغ پرداخت و موجودی فعلی است. همچنین ادمین‌ها باید نوتیفیکیشن تأیید را دریافت کنند.

## 🔄 فرآیند کامل

1. ادمین یک تراکنش پرداخت دستی را در سیستم مشاهده می‌کند
2. پس از تأیید پرداخت واقعی (مثلا کارت به کارت)، ادمین دستور `confirm_payment` را اجرا می‌کند
3. سیستم تراکنش را تأیید می‌کند و موجودی کاربر را افزایش می‌دهد
4. کاربر یک نوتیفیکیشن تأیید پرداخت دریافت می‌کند
5. کاربر اکنون می‌تواند از موجودی خود برای خرید سرویس استفاده کند

## ❗️ نکات مهم

- این دستور را فقط پس از تأیید پرداخت واقعی اجرا کنید
- شناسه تراکنش را از طریق بخش مدیریت تراکنش‌ها پیدا کنید
- برای امنیت بیشتر، فقط ادمین‌ها باید دسترسی اجرای این دستور را داشته باشند
- اگر نوتیفیکیشن‌ها به کاربران ارسال نمی‌شود، مطمئن شوید که:
  - بات تلگرام فعال است
  - سرویس `notification_service` در فایل `bot/main.py` به درستی راه‌اندازی شده است
  - متغیرهای محیطی `BOT_TOKEN` و `ADMIN_IDS` به درستی تنظیم شده‌اند 