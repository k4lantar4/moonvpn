"""
Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒ Ú©Ø§Ù„Ø¨Ú© Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯Ø± Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†
"""

import logging
from aiogram import Router, F
from aiogram.types import CallbackQuery
from sqlalchemy.ext.asyncio import AsyncSession
from aiogram.utils.keyboard import InlineKeyboardBuilder

from core.services.user_service import UserService
from bot.buttons.admin.user_buttons import get_user_list_keyboard, get_user_manage_buttons
from bot.buttons.admin.main_buttons import get_admin_panel_keyboard

logger = logging.getLogger(__name__)

def register_admin_user_callbacks(router: Router) -> None:
    """Ø«Ø¨Øª Ú©Ø§Ù„Ø¨Ú©â€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯Ø± Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†"""
    
    @router.callback_query(F.data == "admin:users")
    async def admin_users(callback: CallbackQuery, session: AsyncSession) -> None:
        """
        Ù‡Ù†Ø¯Ù„Ø± Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
        
        Args:
            callback (CallbackQuery): Ú©Ø§Ù„Ø¨Ú© ØªÙ„Ú¯Ø±Ø§Ù…
            session (AsyncSession): Ù†Ø´Ø³Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        """
        try:
            # Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ†
            user_service = UserService(session)
            user = await user_service.get_user_by_telegram_id(callback.from_user.id)
            
            if not user or user.role not in ["admin", "superadmin"]:
                await callback.answer("â›”ï¸ Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²!", show_alert=True)
                return
            
            # Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
            users = await user_service.get_all_users()
            
            # Ø³Ø§Ø®Øª Ú©ÛŒØ¨ÙˆØ±Ø¯ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
            keyboard = get_user_list_keyboard(users[:10])  # Ù†Ù…Ø§ÛŒØ´ 10 Ú©Ø§Ø±Ø¨Ø± Ø§ÙˆÙ„
            
            await callback.message.edit_text(
                "ğŸ‘¥ <b>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</b>\n\n"
                f"ğŸ”¢ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: {len(users)}\n\n"
                "Ù„Ø·ÙØ§Ù‹ Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
                reply_markup=keyboard,
                parse_mode="HTML"
            )
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ú©Ø§Ù„Ø¨Ú© Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: {e}", exc_info=True)
            await callback.answer("âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª", show_alert=True)
    
    @router.callback_query(F.data.startswith("user:manage:"))
    async def user_manage(callback: CallbackQuery, session: AsyncSession) -> None:
        """
        Ù‡Ù†Ø¯Ù„Ø± Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø®Ø§Øµ
        
        Args:
            callback (CallbackQuery): Ú©Ø§Ù„Ø¨Ú© ØªÙ„Ú¯Ø±Ø§Ù…
            session (AsyncSession): Ù†Ø´Ø³Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        """
        try:
            # Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ†
            user_service = UserService(session)
            admin = await user_service.get_user_by_telegram_id(callback.from_user.id)
            
            if not admin or admin.role not in ["admin", "superadmin"]:
                await callback.answer("â›”ï¸ Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²!", show_alert=True)
                return
            
            # Ø¯Ø±ÛŒØ§ÙØª Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ú©Ø§Ù„Ø¨Ú©
            user_id = int(callback.data.split(":")[-1])
            
            # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
            user = await user_service.get_user(user_id)
            
            if not user:
                await callback.answer("âš ï¸ Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯!", show_alert=True)
                return
            
            # Ø³Ø§Ø®Øª Ú©ÛŒØ¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±
            keyboard = get_user_manage_buttons(user.id)
            
            # Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
            user_info = (
                f"ğŸ‘¤ <b>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±</b>\n\n"
                f"ğŸ†” Ø´Ù†Ø§Ø³Ù‡: {user.id}\n"
                f"ğŸ“± ØªÙ„Ú¯Ø±Ø§Ù…: {user.telegram_id}\n"
                f"ğŸ‘¤ Ù†Ø§Ù…: {user.first_name} {user.last_name or ''}\n"
                f"ğŸŒŸ Ù†Ù‚Ø´: {user.role}\n"
                f"ğŸ“… ØªØ§Ø±ÛŒØ® Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…: {user.created_at.strftime('%Y-%m-%d')}\n"
            )
            
            await callback.message.edit_text(
                user_info,
                reply_markup=keyboard,
                parse_mode="HTML"
            )
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±: {e}", exc_info=True)
            await callback.answer("âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª", show_alert=True)
    
    # Ø§ÛŒÙ†Ø¬Ø§ Ú©Ø§Ù„Ø¨Ú©â€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯ 