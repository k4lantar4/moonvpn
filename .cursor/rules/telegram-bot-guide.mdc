---
description: MoonVPN Telegram Bot Layer Guide
globs: 
alwaysApply: false
---
# ü§ñ MoonVPN Telegram Bot Layer Guide

## üìù Bot Structure Overview
The Telegram bot is built using Aiogram 3.x and follows a modular structure:

- [Main Bot File](mdc:bot/main.py) - Bot initialization and configuration
- [Commands](mdc:bot/commands) - Command handlers (e.g., /start, /buy)
- [Callbacks](mdc:bot/callbacks) - Callback query handlers
- [Buttons](mdc:bot/buttons) - Button generation and layout
- [Keyboards](mdc:bot/keyboards) - Reply keyboard definitions
- [Middlewares](mdc:bot/middlewares) - Authentication and role enforcement
- [Notifications](mdc:bot/notifications) - User notification management
- [Receipts](mdc:bot/receipts) - Receipt handling logic
- [States](mdc:bot/states.py) - Form states for conversations

## ‚úÖ Bot Layer Rules
1. Commands must **only** gather user input and call services
2. Business logic belongs in services, not in bot handlers
3. Use proper error handling and user feedback
4. Each command should follow the same pattern:
   - Input validation
   - Service call
   - Response formatting
   - Error handling

## üß© Common Patterns
```python
# CORRECT PATTERN
@router.message(Command("example"))
async def example_command(message: Message):
    user_id = message.from_user.id
    
    try:
        # Call service to handle business logic
        result = await example_service.perform_action(user_id)
        
        # Format response to user
        await message.answer("Action completed successfully")
    except SomeException as e:
        # Handle error
        await message.answer(f"Error: {str(e)}")
```

## üìä Responsibility Map
- **Commands**: Initial entry points for user commands
- **Callbacks**: Handle button press events
- **Buttons**: Create and organize inline buttons
- **Receipts**: Process payment receipts and forward to admins
- **Notifications**: Send alerts to users and admins

## üîÑ Bot-Service Interaction
Bot handlers must always interact with core services for:
- User management
- Payment processing
- VPN account creation
- Plan management
- Notifications
